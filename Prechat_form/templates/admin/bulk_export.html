{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Bulk Export - {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrahead %}
<style>
    .export-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    .export-section {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .export-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    .export-option {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f8f9fa;
    }
    .export-option:hover {
        border-color: #417690;
        background: #e7f3ff;
    }
    .export-option.selected {
        border-color: #417690;
        background: #e7f3ff;
    }
    .export-option input[type="radio"] {
        display: none;
    }
    .export-option label {
        cursor: pointer;
        font-weight: bold;
        color: #417690;
        margin-bottom: 10px;
        display: block;
    }
    .export-option .description {
        font-size: 0.9em;
        color: #666;
        margin-top: 10px;
    }
    .model-selection {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    .model-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: white;
    }
    .model-card input[type="checkbox"] {
        margin-right: 10px;
    }
    .model-card label {
        font-weight: bold;
        color: #333;
    }
    .model-card .count {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
    }
    .export-btn {
        background: #417690;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 1.1em;
        cursor: pointer;
        transition: background 0.3s;
        width: 100%;
        margin-top: 20px;
    }
    .export-btn:hover {
        background: #2c5aa0;
    }
    .export-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .date-filters {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
    }
    .date-filter input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .progress-container {
        display: none;
        margin: 20px 0;
    }
    .progress-bar {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: #417690;
        width: 0%;
        transition: width 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<div class="export-container">
    <h1>üìä Bulk Data Export</h1>
    <p>Export your prechat form data in various formats with custom filtering options.</p>

    <form id="exportForm" method="post">
        {% csrf_token %}
        
        <!-- Export Format Selection -->
        <div class="export-section">
            <h3>üìã Select Export Format</h3>
            <div class="export-options">
                <div class="export-option" onclick="selectFormat('csv')">
                    <input type="radio" name="format" value="csv" id="format_csv">
                    <label for="format_csv">üìä CSV</label>
                    <div class="description">Comma-separated values, perfect for Excel and data analysis</div>
                </div>
                <div class="export-option" onclick="selectFormat('excel')">
                    <input type="radio" name="format" value="excel" id="format_excel">
                    <label for="format_excel">üìà Excel</label>
                    <div class="description">Microsoft Excel format with multiple sheets</div>
                </div>
                <div class="export-option" onclick="selectFormat('pdf')">
                    <input type="radio" name="format" value="pdf" id="format_pdf">
                    <label for="format_pdf">üìÑ PDF</label>
                    <div class="description">Professional PDF report with charts and summaries</div>
                </div>
                <div class="export-option" onclick="selectFormat('json')">
                    <input type="radio" name="format" value="json" id="format_json">
                    <label for="format_json">üîß JSON</label>
                    <div class="description">Machine-readable format for API integration</div>
                </div>
            </div>
        </div>

        <!-- Data Selection -->
        <div class="export-section">
            <h3>üì¶ Select Data to Export</h3>
            <div class="model-selection">
                <div class="model-card">
                    <input type="checkbox" name="models" value="usercontact" id="model_users" checked>
                    <label for="model_users">üë• User Contacts</label>
                    <div class="count">{{ stats.total_users }} records</div>
                </div>
                <div class="model-card">
                    <input type="checkbox" name="models" value="chatsession" id="model_sessions" checked>
                    <label for="model_sessions">üí¨ Chat Sessions</label>
                    <div class="count">{{ stats.total_sessions }} records</div>
                </div>
                <div class="model-card">
                    <input type="checkbox" name="models" value="formsubmission" id="model_submissions" checked>
                    <label for="model_submissions">üìù Form Submissions</label>
                    <div class="count">{{ stats.total_submissions }} records</div>
                </div>
                <div class="model-card">
                    <input type="checkbox" name="models" value="integrationlog" id="model_logs">
                    <label for="model_logs">üìä Integration Logs</label>
                    <div class="count">{{ stats.total_logs }} records</div>
                </div>
            </div>
        </div>

        <!-- Date Filters -->
        <div class="export-section">
            <h3>üìÖ Date Range (Optional)</h3>
            <div class="date-filters">
                <div class="date-filter">
                    <label for="start_date">Start Date:</label>
                    <input type="date" name="start_date" id="start_date">
                </div>
                <div class="date-filter">
                    <label for="end_date">End Date:</label>
                    <input type="date" name="end_date" id="end_date">
                </div>
            </div>
        </div>

        <!-- Export Button -->
        <div class="export-section">
            <button type="submit" class="export-btn" id="exportBtn">
                üöÄ Start Export
            </button>
            
            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <h4>Exporting data...</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText">Preparing export...</div>
            </div>
        </div>
    </form>
</div>

<script>
function selectFormat(format) {
    // Remove selected class from all options
    document.querySelectorAll('.export-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Add selected class to clicked option
    event.currentTarget.classList.add('selected');
    
    // Check the radio button
    document.getElementById('format_' + format).checked = true;
}

document.getElementById('exportForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate form
    const format = document.querySelector('input[name="format"]:checked');
    const models = document.querySelectorAll('input[name="models"]:checked');
    
    if (!format) {
        alert('Please select an export format.');
        return;
    }
    
    if (models.length === 0) {
        alert('Please select at least one data type to export.');
        return;
    }
    
    // Show progress
    document.getElementById('exportBtn').disabled = true;
    document.getElementById('progressContainer').style.display = 'block';
    
    // Simulate progress (in real implementation, this would be AJAX)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        
        document.getElementById('progressFill').style.width = progress + '%';
        document.getElementById('progressText').textContent = 
            progress < 100 ? `Processing... ${Math.round(progress)}%` : 'Finalizing export...';
        
        if (progress >= 100) {
            clearInterval(progressInterval);
            
            // Submit the form
            setTimeout(() => {
                this.submit();
            }, 1000);
        }
    }, 500);
});

// Set default date range (last 30 days)
const today = new Date();
const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

document.getElementById('end_date').value = today.toISOString().split('T')[0];
document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];

// Select CSV by default
document.getElementById('format_csv').checked = true;
document.querySelector('.export-option').classList.add('selected');
</script>

{% endblock %}
